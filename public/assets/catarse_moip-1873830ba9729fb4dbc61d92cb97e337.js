App.addChild("MoipForm",{el:"form.moip",getMoipToken:function(e){var t=this;$("#MoipWidget").length>0?_.isFunction(e)&&e():$.post("/payment/moip/"+this.backerId+"/get_moip_token").success(function(a){t.paymentChoice.$("input").attr("disabled","disabled"),"fail"==a.get_token_response.status?t.checkoutFailure({Code:0,Mensagem:a.get_token_response.message}):($("#catarse_moip_form").prepend(a.widget_tag),_.isFunction(e)&&e(a))})},checkoutFailure:function(e){this.loader.hide();var t=e.length>0?e[0]:e;914==t.Codigo&&(t.Mensagem+='. Tente <a href="javascript:window.location.reload();">recarregar a página</a> e repetir a operação de pagamento.'),this.message.find("p").html(t.Mensagem),this.message.fadeIn("fast"),$('input[type="submit"]').removeAttr("disabled").show()},checkoutSuccessful:function(e){var t=this;$.post("/payment/moip/"+this.backerId+"/moip_response",{response:e}).success(function(){if(t.loader.hide(),"Cancelado"==e.Status)return t.checkoutFailure({Codigo:0,Mensagem:e.Classificacao.Descricao+". Verifique os dados de pagamento e tente novamente."});if(e.url&&"block"!=$("#payment_type_cards_section").css("display")){var a=$('<a target="__blank">'+e.url+"</a>");a.attr("href",e.url),$(".link_content:visible").empty().html(a),$(".payment_section:visible .subtitle").fadeIn("fast")}else{var n=$("#project_review").data("thank-you-path");location.href=n?n:"/"}})},activate:function(){this.message=this.$(".next_step_after_valid_document .alert-danger"),this.backerId=$("input#backer_id").val(),this.projectId=$("input#project_id").val(),this.loader=this.$(".loader"),window.checkoutSuccessful=_.bind(this.checkoutSuccessful,this),window.checkoutFailure=_.bind(this.checkoutFailure,this)}}),App.views.MoipForm.UserDocument={onContentClick:function(){window.setTimeout(function(){app.moipForm.checkoutSuccessful({StatusPagamento:"Success"})},2e3)},onUserDocumentKeyup:function(e){var t=$(e.currentTarget),a=t.val();t.prop("maxlength",18);var n=this.validateCpf(a),i=this.validateCnpj(a.replace(/[\/.\-\_ ]/g,"")),o=a.replace(/[.\-\_ ]/g,"").length;o>10?("payment_card_cpf"!=t.attr("id")&&(11==o?t.mask("999.999.999-99?999"):14==o&&t.mask("99.999.999/9999-99"),(14!=o||11!=o)&&t.unmask()),n||i?(t.addClass("ok").removeClass("error"),$.post("/projects/"+this.moipForm.projectId+"/backers/"+this.moipForm.backerId+"/update_info",{backer:{payer_document:a}})):t.addClass("error").removeClass("ok")):t.addClass("error").removeClass("ok")},validateCpf:function(e){var t,a,n=0;e=e.replace(/[.\-\_ ]/g,"");var i=Math.floor(parseFloat(e)/100),o=100*i;for(t=0;8>=t;t++)n+=i%10*(t+2),i=Math.floor(i/10);for(a=2>n%11?0:11-n%11,o+=10*a,n=0,i=Math.floor(o/10),t=0;9>=t;t++)n+=i%10*(t+2),i=Math.floor(i/10);return a=2>n%11?0:11-n%11,o+=a,parseFloat(e)===o},validateCnpj:function(e){var t,a,n,i,o,r,c,s;if(s=1,e.length<14&&e.length<15)return!1;for(i=0;i<e.length-1;i++)if(e.charAt(i)!=e.charAt(i+1)){s=0;break}if(s)return!1;for(c=e.length-2,t=e.substring(0,c),a=e.substring(c),n=0,r=c-7,i=c;i>=1;i--)n+=t.charAt(c-i)*r--,2>r&&(r=9);if(o=2>n%11?0:11-n%11,o!=a.charAt(0))return!1;for(c+=1,t=e.substring(0,c),n=0,r=c-7,i=c;i>=1;i--)n+=t.charAt(c-i)*r--,2>r&&(r=9);return o=2>n%11?0:11-n%11,o!=a.charAt(1)?!1:!0}},App.views.MoipForm.addChild("PaymentAccount",_.extend({el:"#payment_type_account_section",events:{"change select#account":"onChangeAccount","click input#build_account_link":"onBuildAccountClick","keyup #user_document_account":"onUserDocumentKeyup","click .link_content a":"onContentClick"},activate:function(){this.moipForm=this.parent,this.$("input#user_document_account").mask("999.999.999-99")},onChangeAccount:function(e){var t=$(e.currentTarget).val();this.$("input#build_account_link").attr("disabled",!(""!=t&&void 0!=t))},onBuildAccountClick:function(e){var t=this;e.preventDefault(),$(e.currentTarget).hide(),t.moipForm.loader.show(),t.moipForm.getMoipToken(function(){var e={Instituicao:$("select#account").val(),Forma:"DebitoBancario"};MoipWidget(e)})}},App.views.MoipForm.UserDocument)),App.views.MoipForm.addChild("PaymentCard",_.extend({el:"#payment_type_cards_section",events:{'keyup input[type="text"]':"creditCardInputValidator","keyup #payment_card_number":"onKeyupPaymentCardNumber","click input#credit_card_submit":"onSubmit","keyup #payment_card_cpf":"onUserDocumentKeyup"},activate:function(){this.moipForm=this.parent,this.$("input#payment_card_date").mask("99/99"),this.$("input#payment_card_birth").mask("99/99/9999"),this.$("input#payment_card_cpf").mask("999.999.999-99"),this.$("input#payment_card_phone").mask("(99) 9999-9999?9")},onKeyupPaymentCardNumber:function(e){this.$("input#payment_card_flag").val(this.getCardFlag($(e.currentTarget).val()))},onSubmit:function(e){var t=this;e.preventDefault(),$(e.currentTarget).hide(),t.moipForm.loader.show(),t.moipForm.getMoipToken(function(){var e={Forma:"CartaoCredito",Instituicao:t.$("input#payment_card_flag").val(),Parcelas:"1",Recebimento:"AVista",CartaoCredito:{Numero:t.$("input#payment_card_number").val(),Expiracao:t.$("input#payment_card_date").val(),CodigoSeguranca:t.$("input#payment_card_source").val(),Portador:{Nome:t.$("input#payment_card_name").val(),DataNascimento:t.$("input#payment_card_birth").val(),Telefone:t.$("input#payment_card_phone").val(),Identidade:t.$("input#payment_card_cpf").val()}}};MoipWidget(e)})},hasContent:function(e){var t=$(e).val().replace(/[\-\.\_\/\s]/g,"");return t&&t.length>0?($(e).addClass("ok").removeClass("error"),!0):($(e).addClass("error").removeClass("ok"),!1)},creditCardInputValidator:function(){var e=this,t=!0;$.each($('#payment_type_cards_section input[type="text"]'),function(a,n){t=e.hasContent(n)}),$("input#credit_card_submit").attr("disabled",!t)},getCardFlag:function(e){var t=(e+"").replace(/\s/g,"");return/^(34|37)/.test(t)&&15==t.length?"AmericanExpress":/^(51|52|53|54|55)/.test(t)&&16==t.length?"Mastercard":!/^(4)/.test(t)||13!=t.length&&16!=t.length?/^(300|301|302|303|304|305|36|38)/.test(t)&&14==t.length?"Diners":/^(38)/.test(t)&&19==t.length?"Hipercard":"Desconhecido":"Visa"}},App.views.MoipForm.UserDocument)),App.views.MoipForm.addChild("PaymentChoice",{el:".list_payment",events:{'change input[type="radio"]':"onListPaymentChange"},onListPaymentChange:function(e){$(".payment_section").fadeOut("fast",function(){var t=$(e.currentTarget).attr("id");$("#"+t+"_section").fadeIn("fast")})},activate:function(){this.$("input#payment_type_cards").click()}}),App.views.MoipForm.addChild("PaymentSlip",_.extend({el:"#payment_type_boleto_section",events:{"click input#build_boleto":"onBuildBoletoClick","click .link_content a":"onContentClick","keyup #user_document_payment_slip":"onUserDocumentPaymentSlipKeyup"},onUserDocumentPaymentSlipKeyup:function(e){var t=$(e.currentTarget);this.onUserDocumentKeyup(e),$("input#build_boleto").attr("disabled",!t.hasClass("ok"))},activate:function(){this.moipForm=this.parent,this.$("input#user_document_payment_slip").mask("999.999.999-99")},onBuildBoletoClick:function(e){var t=this;e.preventDefault(),$(e.currentTarget).hide(),t.moipForm.loader.show(),t.moipForm.getMoipToken(function(){var e={Forma:"BoletoBancario"};MoipWidget(e)})}},App.views.MoipForm.UserDocument)),$(function(){app.createViewGetters()});